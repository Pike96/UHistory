var PiechartView=function(t,e,r){function a(){streakerDataAdded=r,g=f,h=v(streakerDataAdded),(f=h.filter(function(t,e,r){return t.name=streakerDataAdded[e][0],t.value=streakerDataAdded[e][1],I+=t.value,t.value>0})).length>0&&g.length>0&&(w.selectAll("circle").remove(),F.text(function(){return I}),(k=w.selectAll("path").data(f)).enter().append("svg:path").attr("stroke","white").attr("stroke-width",2).attr("cursor","pointer").attr("fill",function(t,e){return x(e)}).on("mouseover",n).on("mouseout",s).on("click",o).transition().duration(d).attrTween("d",c))}function n(t){T.text(t.name),F.text((t.value/I*100).toFixed(1)+"%"),S.text("OF VISITS"),1==p&&t.name!=u.name&&d3.select(this).attr("stroke-width",2).attr("stroke","white").attr("cursor","pointer").attr("opacity",.7),d3.select(this).attr("stroke","#333").attr("opacity",1).moveToFront(),d3.select("#piechart .arc path.selected").moveToFront()}function s(t){0==p?(T.text("TOTAL"),F.text(I),S.text("VISITS"),d3.selectAll("#piechart .arc path").attr("opacity",1).attr("stroke-width",2).attr("stroke","white")):1==p&&t.name!=u.name&&(T.text(u.name),F.text((u.value/I*100).toFixed(1)+"%"),S.text("OF VISITS"),d3.select(this).attr("stroke-width",2).attr("stroke","white").attr("cursor","pointer").attr("opacity",.4))}function o(a){if(a.name!=u.name){for(p=!0,u=a,T.text(a.name),F.text((a.value/I*100).toFixed(1)+"%"),F.attr("font-size",60),S.text("OF VISITS"),d3.selectAll("#piechart .arc path").attr("opacity",.4).attr("stroke","white").classed("selected",!1),selectedThis=d3.select(this),d3.select(this).attr("stroke-width",2).attr("stroke","#333").attr("cursor","pointer").attr("opacity",1).classed("selected",!0).moveToFront(),i=0;i<r.length;i++)if(r[i][0]==a.name)new BarGraphView(t,e,e.getDailyTop()[i],1),new BarGraphView(t,e,e.getHourlyTop()[i],2)}else d3.select(this).attr("stroke-width",2).attr("stroke","white").attr("cursor","pointer").attr("opacity",1),l()}function l(r){p=!1,u=0,T.text("TOTAL"),F.text(I),F.attr("font-size",60),F.attr("dy",20),S.text("VISITS"),d3.select("circle").attr("cursor","default"),d3.selectAll("#piechart .arc path").attr("stroke","white").classed("selected",!1),d3.selectAll("path").attr("opacity",1);new BarGraphView(t,e,e.getDailyAverages(),1),new BarGraphView(t,e,e.getHourlyAverages(),2)}function c(t,e){var r,a;g[e]?(r=g[e].startAngle,a=g[e].endAngle):!g[e]&&g[e-1]?(r=g[e-1].endAngle,a=g[e-1].endAngle):!g[e-1]&&g.length>0?(r=g[g.length-1].endAngle,a=g[g.length-1].endAngle):(r=0,a=0);e=d3.interpolate({startAngle:r,endAngle:a},{startAngle:t.startAngle,endAngle:t.endAngle});return function(t){var r=e(t);return A(r)}}var d=250,p=!1,u=0,h=[],g=[],f=[],v=d3.layout.pie().value(function(t){return t[1]}),x=d3.scale.category20(),A=d3.svg.arc().startAngle(function(t){return t.startAngle}).endAngle(function(t){return t.endAngle}).innerRadius(130).outerRadius(200),m=d3.select("#piechart").append("svg:svg").attr("width",500).attr("height",420),w=m.append("svg:g").attr("class","arc").attr("transform","translate(250,210)"),y=(m.append("svg:g").attr("class","label_group").attr("transform","translate(250,210)"),m.append("svg:g").attr("class","center_group").attr("transform","translate(250,210)")),k=w.append("svg:circle").attr("fill","#EFEFEF").attr("r",200),T=(y.append("svg:circle").attr("fill","white").attr("r",129).attr("cursor","pointer").on("mouseover",function(t){1==p&&(T.text(" "),F.text("Back to total"),F.attr("font-size",30),F.attr("dy",10),S.text(" "),d3.select(this).attr("cursor","pointer"))}).on("mouseout",function(t){F.attr("font-size",60),F.attr("dy",20)}).on("click",l),y.append("svg:text").attr("class","label").attr("dy",-45).attr("text-anchor","middle").attr("fill","#333333").text("TOTAL")),F=y.append("svg:text").attr("class","total").attr("dy",20).attr("text-anchor","middle").attr("fill","#333333");F.attr("font-size",60).text("Select day");var S=y.append("svg:text").attr("class","units").attr("dy",55).attr("text-anchor","middle").attr("fill","#333333").text("Sites");a();var I=0;d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},e.addObserver(this),this.update=function(t){"dataReady"==t&&a()}};