"use strict";function handleClientLoad(){gapi.load("client:auth2")}var bgMod=angular.module("UHistoryBg",[]);bgMod.config(["$compileProvider",function(e){e.aHrefSanitizationWhitelist(/^\s*(https?|ftp|file|chrome-extension):/)}]),bgMod.controller("BgCtrl",["$scope","$window","$filter","$interval",function(e,t,n,a){e.monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],e.firstAuth=a(function(){e.refreshToken()},1e3,1),e.autoAuth=a(function(){e.refreshToken()},18e5),e.refreshToken=function(){"undefined"!=typeof gapi&&chrome.identity.getAuthToken({interactive:!1},function(t){null!=t&&(gapi.auth.setToken({access_token:t}),gapi.client.load("drive","v3").then(function(){e.checker(e.backupHelper)}))})},e.checker=function(t){if("undefined"!=typeof gapi){var n=new Date,a="UHB"+n.getFullYear()+e.monthNames[n.getMonth()-1]+".txt";gapi.client.drive.files.list({q:"trashed = false and name = '"+a+"'",fields:"nextPageToken, files(id, name)"}).then(function(e){var n=e.result.files;return!!(n&&n.length>0)||!!t&&(t(),!1)})}},e.backupHelper=function(){gapi.client.drive.files.list({q:"mimeType = 'application/vnd.google-apps.folder' and name = 'UHistoryBackup'",fields:"nextPageToken, files(id, name)"}).then(function(t){var n=t.result.files;if(n&&n.length>0)e.historyReader(n[0].id,e.saveToFolder);else{var a={name:"UHistoryBackup",mimeType:"application/vnd.google-apps.folder"};gapi.client.drive.files.create({resource:a}).then(function(t){switch(t.status){case 200:var n=t.result;e.historyReader(n.id,e.saveToFolder);break;default:console.log("Error creating the folder, "+t)}})}})},e.saveToFolder=function(t,n,a){const i="(/= _ =)/~",o="\r\n--"+i+"\r\n";var r=new Date,s="UHB"+r.getFullYear()+e.monthNames[r.getMonth()-1]+".txt",l=new FileReader;l.readAsBinaryString(t),l.onload=function(e){var t="application/octet-stream",r={name:s,mimeType:t,parents:[n]},d=btoa(l.result),c=o+"Content-Type: application/json\r\n\r\n"+JSON.stringify(r)+o+"Content-Type: "+t+"\r\nContent-Transfer-Encoding: base64\r\n\r\n"+d+"\r\n--(/= _ =)/~--",u=gapi.client.request({path:"/upload/drive/v3/files",method:"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+i+'"'},body:c});a||(a=function(e){console.log(e)}),u.execute(a)}},e.historyReader=function(n,a){var i=new Date,o=e.getLastMonthPeriod(i);chrome.history.search({text:"",maxResults:9999999,startTime:o[0].getTime(),endTime:o[1].getTime()},function(i){if(t.res=i,0!=i.length){var o=Object.keys(i[0]);e.append(o.join("```"));for(var r,s=0;s<i.length;s++){r="";for(var l=0;l<o.length;l++)r+="```"+i[s][o[l]]+"```",l!==o.length-1&&(r+="|@|@");e.append("\n"+r)}var d=new Blob([data.innerText],{type:"application/octet-steam"});a(d,n)}})},e.append=function(e){t.data.appendChild(document.createTextNode(e))},document.addEventListener("DOMContentLoaded",function(){t.data=document.getElementById("data")}),e.getLastMonthPeriod=function(e){var t=[],n=new Date(e.getTime());n.setMonth(n.getMonth()-1),n.setDate(1),n.setHours(0),n.setMinutes(0),n.setSeconds(0),n.setMilliseconds(0);var a=new Date(n.getTime());return a.setMonth(a.getMonth()+1),t.push(new Date(n.getTime())),t.push(new Date(a.getTime())),t}}]);